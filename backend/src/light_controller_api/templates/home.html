<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 IoT Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-color: #0056b3;
            --bg-light: #f4f4f4;
            --text-dark: #333;
            --danger: #ff4444;
            --success: #28a745;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text-dark);
        }

        /* Header */
        header {
            border-bottom: 3px solid var(--primary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { margin: 0; }

        .header-actions button {
            margin-left: 10px;
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 4px;
            font-weight: bold;
        }

        .header-actions button:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Main Split Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel */
        .left-panel {
            width: 35%;
            border-right: 3px solid var(--primary-color);
            padding: 20px;
            overflow-y: auto;
            background: #fff;
        }

        /* Right Panel */
        .right-panel {
            width: 65%;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
        }

        /* Bottom Slider */
        .bottom-panel {
            height: 220px;
            border-top: 3px solid var(--primary-color);
            background: #e9ecef;
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex-shrink: 0;
        }

        /* Card Styles */
        .esp-card {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .esp-card:hover { background: #f0f8ff; }
        .esp-card.active {
            background: #e3f2fd;
            border-left: 5px solid var(--primary-color);
            border-color: var(--primary-color);
        }

        .esp-info {
            flex-grow: 1;
        }

        .device-card {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .delete-btn:hover { background: #cc0000; }

        /* Slider Styles */
        .slider-wrapper {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 0;
            height: 100%;
            align-items: center;
        }

        .shop-card {
            min-width: 160px;
            height: 140px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
            /* Cursor is handled in JS now */
        }

        .shop-card.clickable:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .shop-card.readonly {
            background-color: #f9f9f9;
            opacity: 0.8;
            cursor: default;
        }

        /* Modal / Forms */
        .add-form-container {
            display: none;
            background: #fff;
            padding: 15px;
            border: 2px dashed var(--primary-color);
            margin-bottom: 20px;
        }
        .add-form-container.show { display: block; }

        /* Center Modal Helper */
        .modal-center {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 100;
            border: 2px solid var(--primary-color);
            display: none;
        }
        .modal-center.show { display: block; }

        /* Modal overlay */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 99; display: none;
        }
        .modal-overlay.show { display: block; }

        .hidden { display: none !important; }

        input, select {
            width: 100%; padding: 8px; margin: 5px 0 15px 0;
            box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;
        }

        button { padding: 10px 15px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-cancel { background: #ccc; color: #333; }
    </style>
</head>
<body>

    <div id="overlay" class="modal-overlay" onclick="app.closeAllModals()"></div>

    <header>
        <h2>IoT Control Center</h2>
        <div class="header-actions">
            <span id="loading-indicator" style="display:none; color:gray; margin-right:10px;">Loading...</span>
            <button onclick="app.init()">Refresh ‚ü≥</button>
            <button onclick="app.openModal('add-esp32-modal')">Add ESP32 +</button>
        </div>
    </header>

    <div class="main-container">

        <div class="left-panel">
            <h3>All ESP32 Devices</h3>
            <div id="esp-list-container" style="margin-top: 15px;"></div>
        </div>

        <div class="right-panel">
            <div id="right-panel-placeholder" style="text-align: center; color: #777; margin-top: 50px;">
                <h3>Select an ESP32 from the left to view devices</h3>
            </div>

            <div id="right-panel-content" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                    <h3 id="selected-esp-title">ESP Devices</h3>
                    <button class="header-actions" style="background:#28a745; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;" onclick="app.openAddDeviceForm()">+ Add Component</button>
                </div>

                <div id="add-component-form" class="add-form-container">
                      <h4>Register New Component</h4>
                      <label>Available Slot ID</label>
                      <select id="available-id-select"></select>

                      <label>Device Name (Type)</label>
                      <input type="text" id="dev_name" placeholder="Fan / Light">

                      <label>Mode</label>
                      <select id="dev_is_read">
                        <option value="false">Writable (Control)</option>
                        <option value="true">Read Only (Sensor)</option>
                      </select>

                      <button class="btn-primary" onclick="app.registerComponent()">Register</button>
                      <button class="btn-cancel" onclick="document.getElementById('add-component-form').classList.remove('show')">Cancel</button>
                </div>

                <div id="device-list-container"></div>
            </div>
        </div>
    </div>

    <div class="bottom-panel">
        <h3>System Overview (Click component to Control)</h3>
        <div class="slider-wrapper" id="slider-container"></div>
    </div>

    <div id="add-esp32-modal" class="modal-center">
      <h3>Register New ESP32</h3>
      <label>ESP32 Name</label>
      <input type="text" id="esp_name" placeholder="esp32">
      <label>IP Address</label>
      <input type="text" id="esp_ip" placeholder="192.168.1.214">
      <label>Port</label>
      <input type="number" id="esp_port" placeholder="80">
      <div style="text-align: right;">
          <button class="btn-cancel" onclick="app.closeAllModals()">Cancel</button>
          <button class="btn-primary" onclick="app.registerEsp32()">Register</button>
      </div>
    </div>

    <div id="control-device-modal" class="modal-center">
        <h3 id="control-title">Control Device</h3>
        <p id="control-subtitle" style="color:#666; font-size:12px; margin-bottom:15px;"></p>

        <div id="control-input-container">
            <label>Set Value (Data)</label>
            <input type="text" id="control_value" placeholder="1 or 0, or 0-255">
        </div>

        <div style="text-align: right;">
            <button class="btn-cancel" onclick="app.closeAllModals()">Close</button>
            <button id="btn-send-command" class="btn-primary" onclick="app.sendDeviceCommand()">Send Command</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://172.20.10.6:5000/api/esp32';

        const app = {
            state: {
                currentEsp: null,
                esps: [],
                controlTarget: null
            },

            init: async () => {
                app.toggleLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/get/esp32`);
                    const data = await response.json();
                    app.state.esps = Array.isArray(data) ? data : [];
                    app.renderEspList();
                    app.loadGlobalSlider();
                } catch (error) {
                    console.error("API Error:", error);
                }
                app.toggleLoading(false);
            },

            renderEspList: () => {
                const container = document.getElementById('esp-list-container');
                container.innerHTML = '';

                app.state.esps.forEach(esp => {
                    const div = document.createElement('div');
                    div.className = 'esp-card';

                    if (app.state.currentEsp && app.state.currentEsp.esp32_id === esp.esp32_id) {
                        div.classList.add('active');
                    }

                    div.onclick = () => app.selectEsp(esp, div);

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'esp-info';
                    infoDiv.innerHTML = `<strong>${esp.name}</strong><br><small>${esp.ip_address}</small>`;

                    const delBtn = document.createElement('button');
                    delBtn.innerHTML = "‚úñ";
                    delBtn.className = "delete-btn";
                    delBtn.title = "Delete Controller";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        app.deleteEsp32(esp.esp32_id || esp.id);
                    };

                    div.appendChild(infoDiv);
                    div.appendChild(delBtn);
                    container.appendChild(div);
                });
            },

            selectEsp: async (esp, element) => {
                app.state.currentEsp = esp;
                document.querySelectorAll('.esp-card').forEach(el => el.classList.remove('active'));
                if(element) element.classList.add('active');

                document.getElementById('right-panel-placeholder').classList.add('hidden');
                document.getElementById('right-panel-content').classList.remove('hidden');
                document.getElementById('selected-esp-title').innerText = `Devices in ${esp.name}`;
                document.getElementById('add-component-form').classList.remove('show');

                await app.fetchEspDevices(esp.esp32_id);
            },

            fetchEspDevices: async (espId) => {
                const container = document.getElementById('device-list-container');
                container.innerHTML = 'Loading...';
                try {
                    const response = await fetch(`${API_BASE}/get/devices?esp32_id=${espId}`);
                    const devices = await response.json();
                    app.renderDeviceList(devices);
                } catch (e) {
                    container.innerHTML = 'Error loading devices (Check API Console)';
                }
            },

            renderDeviceList: (devices) => {
                const container = document.getElementById('device-list-container');
                container.innerHTML = '';

                if (!Array.isArray(devices) || devices.length === 0) {
                    container.innerHTML = '<p style="padding:10px; color:#777;">No components found or invalid data.</p>';
                    return;
                }

                devices.forEach(dev => {
                    const div = document.createElement('div');
                    div.className = 'device-card';

                    const displayName = dev.type || dev.name || 'Unknown Device';
                    const isReadOnly = (String(dev.is_read) === 'true' || dev.is_read === 1 || dev.is_read === true);
                    const icon = isReadOnly ? 'lock' : 'toggle_on';

                    div.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="material-icons-round" style="color:#0056b3;">${icon}</span>
                            <div>
                                <strong>${displayName}</strong><br>
                                <small>ID: ${dev.device_id} | ${isReadOnly ? 'Sensor (Read-Only)' : 'Control (Writable)'}</small>
                            </div>
                        </div>
                        <button class="delete-btn" onclick="app.deleteDevice(${dev.device_id})">Delete</button>
                    `;
                    container.appendChild(div);
                });
            },

            // --- 3. GLOBAL SLIDER ---
            loadGlobalSlider: async () => {
                const slider = document.getElementById('slider-container');
                slider.innerHTML = '';

                for(let esp of app.state.esps) {
                    try {
                        const res = await fetch(`${API_BASE}/get/devices?esp32_id=${esp.esp32_id}`);
                        const devices = await res.json();

                        if(Array.isArray(devices)) {
                            devices.forEach(dev => {
                                const card = document.createElement('div');
                                card.className = 'shop-card';

                                const displayName = dev.type || dev.name || 'Device';
                                // Determine Read-Only Status
                                const isReadOnly = (String(dev.is_read_only) === 'true' || dev.is_read === 1 || dev.is_read === true);

                                card.innerHTML = `
                                    <div style="font-size:24px;">${isReadOnly ? 'üå°Ô∏è' : 'üîå'}</div>
                                    <strong>${displayName}</strong>
                                    <small>${esp.name} (ID:${dev.device_id})</small>
                                    <small>(value:${dev.value})</small>
                                    <small>(Gpio:${dev.gpio_pin})</small>
                                    <small>(ControlType:${dev.control_type})</small>
                                `;

                                // --- KEY LOGIC REQUESTED ---
                                if (!isReadOnly) {
                                    // It is WRITABLE: Add click event and style
                                    card.classList.add('clickable');
                                    card.onclick = () => {
                                        app.openControlModal(esp.esp32_id, dev.device_id, displayName);
                                    };
                                } else {
                                    // It is READ-ONLY: No click event, add readonly style
                                    card.classList.add('readonly');
                                    // card.onclick is null by default
                                }

                                slider.appendChild(card);
                            });
                        }
                    } catch(e) { console.log("Skipping ESP", esp.name); }
                }
            },

            openControlModal: (espId, deviceId, name) => {
                app.state.controlTarget = { esp32_id: espId, device_id: deviceId };
                document.getElementById('control-title').innerText = `Control: ${name}`;
                document.getElementById('control-subtitle').innerText = `ESP ID: ${espId} | Device ID: ${deviceId}`;
                document.getElementById('control_value').value = "";

                app.openModal('control-device-modal');
            },

            sendDeviceCommand: async () => {
                const target = app.state.controlTarget;
                const value = document.getElementById('control_value').value;

                if(!target || value === "") {
                    alert("Please enter a value.");
                    return;
                }

                try {
                    const payload = {
                        esp32_id: target.esp32_id,
                        device_id: target.device_id,
                        data_value: value
                    };

                    console.log("Sending Command:", payload);

                    const res = await fetch(`${API_BASE}/put/device`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = await res.text();
                    if (res.ok) {
                        alert(`Success! Server Response: ${text}`);
                        app.closeAllModals();
                    } else {
                        alert(`Failed: ${text}`);
                    }

                } catch(e) {
                    console.error(e);
                    alert("Error sending command.");
                }
            },

            deleteEsp32: async (esp32Id) => {
                if (!confirm("Are you sure you want to delete this ESP32?")) return;
                try {
                    const res = await fetch(`${API_BASE}/esp32/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ esp32_id: esp32Id })
                    });

                    const data = await res.json().catch(() => ({}));

                    if (res.ok && (data.success === true || data.success === undefined)) {
                        alert("Deleted Successfully");
                        app.state.currentEsp = null;
                        document.getElementById('right-panel-content').classList.add('hidden');
                        document.getElementById('right-panel-placeholder').classList.remove('hidden');
                        app.init();
                    } else {
                        alert("Delete Failed: " + (data.message || "Unknown error"));
                    }
                } catch (e) {
                    alert("Network Error during delete.");
                }
            },

            deleteDevice: async (deviceId) => {
                if(!confirm("Delete this device?")) return;
                const espId = app.state.currentEsp.esp32_id;
                try {
                    await fetch(`${API_BASE}/delete/device`, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ esp32_id: espId, device_id: deviceId })
                    });
                    app.fetchEspDevices(espId);
                    app.loadGlobalSlider();
                } catch (e) { alert("Delete failed"); }
            },

            registerComponent: async () => {
                const deviceId = parseInt(document.getElementById('available-id-select').value);
                const name = document.getElementById('dev_name').value.trim();
                const isRead = document.getElementById('dev_is_read').value === "true";
                const espId = app.state.currentEsp.esp32_id;

                if (!name || isNaN(deviceId)) { alert("Please fill all fields"); return; }

                try {
                    await fetch(`${API_BASE}/register_esp32/device`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ esp32_id: espId, device_id: deviceId, type: name, is_read: isRead })
                    });
                    document.getElementById('add-component-form').classList.remove('show');
                    app.fetchEspDevices(espId);
                    app.loadGlobalSlider();
                } catch (e) { alert("Registration failed"); }
            },

            registerEsp32: async () => {
                const name = document.getElementById("esp_name").value.trim();
                const ip = document.getElementById("esp_ip").value.trim();
                const port = parseInt(document.getElementById("esp_port").value);

                if (!name || !ip || !port) { alert("All fields required"); return; }

                try {
                    await fetch(`${API_BASE}/register/device`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name, ip_address: ip, port: port })
                    });
                    app.closeAllModals();
                    app.init();
                } catch (e) { alert("ESP32 registration failed"); }
            },

            openAddDeviceForm: async () => {
                if (!app.state.currentEsp) return;
                const espId = app.state.currentEsp.esp32_id;
                try {
                    const response = await fetch(`${API_BASE}/available?esp32_id=${espId}`);
                    const data = await response.json();
                    const select = document.getElementById('available-id-select');
                    select.innerHTML = '';
                    if (!data.available_device_ids || data.available_device_ids.length === 0) {
                        const opt = document.createElement('option'); opt.innerText = "No slots"; opt.disabled = true; select.appendChild(opt);
                    } else {
                        data.available_device_ids.forEach(id => {
                            const opt = document.createElement('option'); opt.value = id; opt.innerText = `Slot ${id}`; select.appendChild(opt);
                        });
                    }
                    document.getElementById('add-component-form').classList.add('show');
                } catch (e) { alert("Error checking slots"); }
            },

            openModal: (id) => {
                document.getElementById('overlay').classList.add('show');
                document.getElementById(id).classList.add('show');
            },

            closeAllModals: () => {
                document.getElementById('overlay').classList.remove('show');
                document.querySelectorAll('.modal-center').forEach(el => el.classList.remove('show'));
            },

            toggleLoading: (show) => {
                document.getElementById('loading-indicator').style.display = show ? 'inline' : 'none';
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>